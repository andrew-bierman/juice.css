name: Release

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g. 0.1.0)"
                required: true
                type: string

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2

            - name: Install dependencies
              run: bun install

            - name: Update version in package.json
              run: |
                  bun -e "
                    const pkg = await Bun.file('package.json').json();
                    pkg.version = '${{ inputs.version }}';
                    await Bun.write('package.json', JSON.stringify(pkg, null, '\t') + '\n');
                  "

            - name: Rebuild with new version
              run: bun run build

            - name: Commit version bump
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add package.json out/
                  git diff --staged --quiet || (git commit -m "chore: bump version to ${{ inputs.version }}" && git push)

            - name: Create tag
              run: |
                  git tag ${{ inputs.version }}
                  git push origin ${{ inputs.version }}

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.version }}
                  generate_release_notes: true
                  files: |
                      out/juice.css
                      out/juice-light.css
                      out/juice-dark.css
